angular.module("deskworks.SetupImportCtrl",["ngStorage","deskworks.state","deskworks.helper","deskworks.importSteps","deskworks.importStepInit","deskworks.importStepImport","deskworks.importStepComplete","deskworks.purge.service"]).controller("SetupImportCtrl",["$scope","$localStorage","$timeout","dwAlerts","state","helper","importSteps","purgeService",function(e,t,r,n,i,o,s,a){"use strict";var u=this,d=t.$default({import:{}}).import;Object.keys(d).forEach(function(e){var t=e.match(/^v(\d+)$/i);(!t||t&&1!=+t[1])&&delete d[e]});var c=d.v1=d.v1||{},l=e.$ls=c[i.getCurrentCenterId()]=c[i.getCurrentCenterId()]||{};l.step=l.step||0,l.sheets=l.sheets||[],u.steps=s,e.$watch("$ls.step",function(){i.setPageTitle("Import "+u.steps[l.step].name)}),u.purge=function(){if(window.confirm("It will purge all data. Are you sure?"))return a.purgeMembers().catch(function(e){return n.error(e,"Failed to purge members.")}).then(function(){return a.purgeProducts().catch(function(e){return n.error(e,"Failed to purge products.")})}).then(function(){return a.purgePriceLists(i.getCurrentCenterId()).catch(function(e){return n.error(e,"Failed to purge price lists.")})}).then(function(){return a.purgeMembershipTypes().catch(function(e){return n.error(e,"Failed to purge membership categories.")})}).then(function(){return a.purgeReservationCategories().catch(function(e){return n.error(e,"Failed to purge reservation categories.")})}).then(function(){Object.keys(c).forEach(function(e){c[e].step=0,c[e].sheets.splice(0,c[e].sheets.length)})})}}]),angular.module("deskworks.importSteps",["deskworks.importFieldsReservationCategories","deskworks.importHooksReservationCategories","deskworks.importFieldsReservationUnits","deskworks.importHooksReservationUnits","deskworks.importFieldsOtherProducts","deskworks.importHooksOtherProducts","deskworks.importFieldsMembershipProducts","deskworks.importHooksMembershipProducts","deskworks.importFieldsMembers","deskworks.importHooksMembers"]).factory("importSteps",["importFieldsReservationCategories","importHooksReservationCategories","importFieldsReservationUnits","importHooksReservationUnits","importFieldsOtherProducts","importHooksOtherProducts","importFieldsMembershipProducts","importHooksMembershipProducts","importFieldsMembers","importHooksMembers",function(e,t,r,n,i,o,s,a,u,d){"use strict";return[{id:"init",name:"Wizard"},{id:"reservationCategories",name:"Reservation Categories",sheetPattern:/Reservation\s+Categories/i,fields:e,hooks:t},{id:"otherProducts",name:"Other Products",sheetPattern:/Products.+Prices$/i,fields:i,hooks:o},{id:"membershipProducts",name:"Membership Products",sheetPattern:/Membership.+Products.+Prices/i,fields:s,hooks:a},{id:"reservationUnits",name:"Reservation Units",sheetPattern:/Reservation\s+Units/i,fields:r,hooks:n},{id:"members",name:"Members",sheetPattern:/Members.+Recurring.+Billing/i,fields:u,hooks:d},{id:"complete",name:"Complete"}]}]),angular.module("deskworks.handsontable",["deskworks.handsontable.htHeaderExtra","deskworks.handsontable.htRowExtra","deskworks.handsontable.htBodyExtra"]).directive("handsontable",function(){"use strict";return{restrict:"E",scope:!0,controller:"HandsontableCtrl as ht",bindToController:{data:"<htData",renderer:"<htRenderer",manualColumnWidths:"<htManualColumnWidths"},compile:function(){return function(e,t,r,n){if(!window.Handsontable)return console.error("Handsontable component is not found.");e.$watch("ht.data",function(r){angular.isArray(r)&&angular.isArray(r[0])&&(n.settings.data=r,n.instance?n.instance.updateSettings(n.settings):n.instance=new Handsontable(t[0],n.settings),e.$broadcast("ht:dataChange",n.settings.data))}),e.$on("$destroy",function(){n.instance&&(n.instance.destroy(),delete n.instance)})}}}}).controller("HandsontableCtrl",["$scope","$element","$attrs","$timeout",function(e,t,r,n){"use strict";var i=this,o=document.getElementById("htImport"),s=o.addEventListener;o.addEventListener=function(e){if("wheel"!==e)return s.apply(o,arguments)},i.settings={data:i.data,rowHeaders:!0,colHeaders:!0,manualColumnResize:!0,autoWrapRow:!0,autoWrapCol:!0,autoInsertRow:!1,autoRowSize:!0,autoColumnSize:!0,allowInsertColumn:!1,enterBeginsEditing:!1,renderAllRows:!0,viewportColumnRenderingOffset:100,cells:function(){return{renderer:i.renderer}},contextMenu:["row_above","row_below","remove_row"],afterSelectionEnd:function(t,r){e.$apply(function(){e.$emit("ht:afterSelection",t,r)})},afterDeselect:function(){e.$apply(function(){e.$emit("ht:afterDeselect")})},afterChange:function(){e.$root.$$phase||e.$apply(function(){e.$emit("ht:afterChange")})},afterRender:function(){if(e.$root.$$phase)return n(function(){e.$emit("ht:afterRender")});e.$apply(function(){e.$emit("ht:afterRender")})},afterCreateRow:function(t,r){e.$apply(function(){e.$emit("ht:afterCreateRow",t,r)})},afterRemoveRow:function(t,r){e.$apply(function(){e.$emit("ht:afterRemoveRow",t,r)})},init:function(){this.getPlugin("manualColumnResize").manualColumnWidths=i.manualColumnWidths||[]},afterUpdateSettings:function(){this.getPlugin("manualColumnResize").manualColumnWidths=i.manualColumnWidths||[],this.getPlugin("autoRowSize").recalculateAllRowsHeight()},afterGetColHeader:function(e,t){e>=0&&t.setAttribute("htcol",e)},afterGetRowHeader:function(e,t){e>=0&&t.setAttribute("htrow",e)}},e.$on("ht:commitValue",function(e,t){var r=i.instance.getActiveEditor();r&&r._opened&&(r.setValue(t),r.focus(),r.close())}),e.$on("ht:render",function(){i.instance&&i.instance.render()})}]),angular.module("deskworks.handsontable.htBodyExtra",[]).directive("htBodyExtra",["$compile",function(e){"use strict";return{restrict:"E",require:"^handsontable",compile:function(t,r){var n=t.html();return t.remove(),function(t,r,i,o){var s=r.parent()[0];o.bodyExtraElement||(o.bodyExtraElement=e(n.replace(/\$row/g,"ht.erow").replace(/\$col/g,"ht.ecol"))(t).addClass("ht-body-extra")),t.$on("ht:afterRender",function(e){e.stopPropagation();var t=angular.element(s.querySelector(".ht_master .wtSpreader"));t[0].querySelector(".ht-body-extra")||t.append(o.bodyExtraElement),o.repositionBodyExtra()}),o.repositionBodyExtra=function(){if(o.erow>=0&&o.ecol>=0){var e=s.querySelector('td[rc="'+o.erow+"x"+o.ecol+'"]');e&&(o.bodyExtraElement.css("top",e.offsetTop+"px"),o.bodyExtraElement.css("left",Math.floor(e.offsetLeft+e.offsetWidth/2)+"px"))}},t.$on("ht:afterSelection",function(e,t,r){e.stopPropagation(),o.erow=t,o.ecol=r,o.repositionBodyExtra()}),t.$on("ht:afterDeselect",function(e,t,r){e.stopPropagation(),o.erow=-1,o.ecol=-1})}}}}]),angular.module("deskworks.handsontable.htHeaderExtra",[]).directive("htHeaderExtra",["$compile",function(e){"use strict";return{restrict:"E",require:"^handsontable",compile:function(t,r){var n=t.html();return t.remove(),function(t,r,i,o){var s=r.parent()[0];t.$on("ht:afterRender",function(r){var i=angular.element(s.querySelector(".ht_master .wtSpreader"));o.headExtraScopes||angular.isArray(o.settings.data)&&angular.isArray(o.settings.data[0])&&(o.headExtraScopes=o.settings.data[0].map(function(r,o){var s=t.$new();return i.append(e(n.replace(/\$col/g,o))(s).addClass("ht-head-extra")),s})),angular.forEach(i[0].querySelectorAll(".ht-head-extra"),function(e){e.style.display="none"}),angular.forEach(s.querySelectorAll(".ht_master th[htcol]"),function(e){var t=i[0].querySelectorAll(".ht-head-extra")[e.getAttribute("htcol")];t.style.left=e.offsetLeft+Math.floor(e.offsetWidth/2)+"px",t.style.top=e.offsetTop+"px",t.style.display=""})}),t.$on("ht:dataChange",function(e,t){var r=s.querySelector(".ht_master .wtSpreader");r&&(angular.element(r.querySelectorAll(".ht-head-extra")).remove(),angular.forEach(o.headExtraScopes,function(e){e.$destroy()}),delete o.headExtraScopes)})}}}}]),angular.module("deskworks.handsontable.htRowExtra",[]).directive("htRowExtra",["$compile",function(e){"use strict";return{restrict:"E",require:"^handsontable",compile:function(t,r){var n=t.html();return t.remove(),function(t,r,i,o){var s=r.parent()[0];function a(e,t){var r=s.querySelector(".ht_clone_left .wtSpreader");o.rowExtraScopes&&(angular.element(r.querySelectorAll(".ht-row-extra")).remove(),angular.forEach(o.rowExtraScopes,function(e){e.$destroy()}),delete o.rowExtraScopes)}t.$on("ht:afterRender",function(r){var i=angular.element(s.querySelector(".ht_clone_left .wtSpreader"));o.rowExtraScopes||angular.isArray(o.settings.data)&&angular.isArray(o.settings.data[0])&&(o.rowExtraScopes=o.settings.data.map(function(r,o){var s=t.$new();return i.append(e(n.replace(/\$row/g,o))(s).addClass("ht-row-extra")),s})),angular.forEach(i[0].querySelectorAll(".ht-row-extra"),function(e){e.style.display="none"}),angular.forEach(s.querySelectorAll(".ht_clone_left th[htrow]"),function(e){var t=i[0].querySelectorAll(".ht-row-extra")[e.getAttribute("htrow")];t.style.left=e.offsetLeft+"px",t.style.top=e.offsetTop+"px",t.style.width=e.offsetWidth+"px",t.style.height=e.offsetHeight+"px",t.style.display=""})}),t.$on("ht:afterCreateRow",a),t.$on("ht:afterRemoveRow",a),t.$on("ht:dataChange",a)}}}}]),angular.module("deskworks.importHandsontable",["deskworks.helper","deskworks.dwAlerts","deskworks.importStripDataComments","deskworks.importDetectHeadRowIdx","deskworks.importAutoMapColumns"]).directive("importHandsontable",function(){"use strict";return{restrict:"E",scope:!0,templateUrl:"handsontable/import-handsontable.tpl.html",controller:"ImportHandsontableCtrl as $ctrl",bindToController:{step:"<",sheet:"<",fields:"<",onValidate:"&",unMappedFields:"="}}}).controller("ImportHandsontableCtrl",["$scope","$window","$timeout","dwAlerts","helper","importStripDataComments","importDetectHeadRowIdx","importAutoMapColumns",function(e,t,r,n,i,o,s,a){"use strict";var u=this;function d(e){return e.map(function(e){return{cellsMeta:Array.apply(null,Array(e.length)).map(function(){return{}})}})}e.$watch("$ctrl.sheet",function(){var t;u.sheet&&(u.sheet.mappedToStep||(o(u.sheet.data),u.sheet.headRowIdx=s(u.sheet.data,u.fields),u.sheet.mapping=a(u.sheet.data,u.fields,u.sheet.headRowIdx),u.sheet.headRowIdx>=0?(u.sheet.mappedToStep=u.step,u.sheet.rowsMeta=d(u.sheet.data),(t=u.sheet).headRowIdx<0||(t.rowsMeta.slice(0,t.headRowIdx).forEach(function(e){e.ignore=!0}),t.rowsMeta[t.headRowIdx].headRow=!0)):u.sheet.rowsMeta=u.sheet.rowsMeta||d(u.sheet.data)),r(function(){e.$broadcast("ht:render")}))}),e.$watch("$ctrl.sheet.mapping",function(e){e&&(u.unMappedFields=u.fields.filter(function(t){return e.indexOf(t.id)<0}),u.availableFields=e.map(function(t){return u.fields.filter(function(r){return r.id===t||e.indexOf(r.id)<0})}),u.mappingFields=e.map(function(e){return i.findByKeyValue(u.fields,"id",e)}),u.onValidate())},!0),e.$on("ht:afterCreateRow",function(e,t,r){e.stopPropagation(),u.sheet.headRowIdx>=t&&(u.sheet.headRowIdx+=r);var n=u.sheet.rowsMeta.slice(0,t),i=Array.apply(null,Array(r)).map(function(){return{cellsMeta:Array.apply(null,Array(u.sheet.data[0].length)).map(function(){return{}})}}),o=u.sheet.rowsMeta.slice(t);u.sheet.rowsMeta=n.concat(i).concat(o),u.onValidate()}),e.$on("ht:afterRemoveRow",function(e,t,r){e.stopPropagation(),u.sheet.headRowIdx>=t+r?u.sheet.headRowIdx-=r:u.sheet.headRowIdx>=t&&(u.sheet.headRowIdx=-1),u.sheet.rowsMeta.splice(t,r),u.onValidate()}),e.$on("ht:afterChange",function(e){e.stopPropagation(),u.onValidate()}),u.cellRenderer=function(e,t,r,n,i,o,s){if(t.innerHTML=o,t=angular.element(t),u.sheet.rowsMeta&&u.sheet.rowsMeta[r]&&u.sheet.rowsMeta[r].cellsMeta&&u.sheet.rowsMeta[r].cellsMeta[n])return u.sheet.rowsMeta[r].cellsMeta[n].invalid&&(t.addClass("ht-invalid"),t[0].innerHTML+='<span class="fa fa-exclamation-triangle"></span>'),u.sheet.rowsMeta[r].headRow&&t.addClass("ht-head-row"),u.sheet.rowsMeta[r].ignore&&t.addClass("ht-ignore"),t.attr("rc",r+"x"+n),t[0]},u.onClickRowIcon=function(e){var t=u.sheet.rowsMeta[e];t.headRow||(t.ignore=!t.ignore,u.onValidate())},u.onSelectValidData=function(t,r,n){if(u.sheet.data.reduce(function(e,t,i){return u.sheet.rowsMeta[i].invalid&&(t[n]||"")===(u.sheet.data[r][n]||"")?++e:e},0)>1){var o='"'+i.findByKeyValue(u.fields,"id",u.sheet.mapping[n]).name+'" column contains more "'+(u.sheet.data[r][n]||"empty")+'" occurrences. Fix them all to "'+t+'" automatically?';if(confirm(o))for(var s=0;s<u.sheet.data.length;s++)s!==r&&u.sheet.rowsMeta[s].invalid&&(u.sheet.data[s][n]||"")===(u.sheet.data[r][n]||"")&&(u.sheet.data[s][n]=t)}u.sheet.data[r][n]=t,e.$broadcast("ht:commitValue",t),u.onValidate()}}]),angular.module("deskworks.importAutoMapColumns",[]).factory("importAutoMapColumns",["helper",function(e){"use strict";return function(t,r,n){if(angular.isArray(r)&&angular.isArray(t)){if(n<0)return Array.apply(null,Array(t[0].length)).map(function(){return null});var i=r.slice();return t[n].map(function(t){for(var r=0;r<i.length;r++)if(e.trim(t).match(i[r].pattern))return i.splice(r,1)[0].id})}}}]),angular.module("deskworks.importCollectStats",[]).factory("importCollectStats",function(){"use strict";return function(e){var t={create:0,update:0,existing:0,ignore:0,invalid:0,error:0};return angular.forEach(e,function(e){!e.ignore||e.headRow||e.id||t.ignore++,e.id||e.ignore||e.headRow||e.empty||e.invalid||t.create++,!e.id||e.ignore||e.invalid||t.update++,e.id&&e.ignore&&t.existing++,e.invalid&&t.invalid++,e.error&&e.ignore&&t.error++}),t}}),angular.module("deskworks.importDetectHeadRowIdx",[]).factory("importDetectHeadRowIdx",["helper",function(e){"use strict";return function(t,r){if(angular.isArray(r)&&angular.isArray(t)){var n=r.slice(),i=t.slice(0,5).map(function(t){var r=0;return t.forEach(function(t){for(var i=0;i<n.length;i++)if(e.trim(t).match(n[i].pattern)){n.splice(i,1),r++;break}}),r}),o=i.indexOf(Math.max.apply(Math,i));return i[o]>=r.length/1.5?o:-1}}}]),angular.module("deskworks.importDetectSubgroups",["deskworks.helper"]).factory("importDetectSubgroups",["helper",function(e){"use strict";return function(t,r,n){var i=n.reduce(function(t,r){var n=e.findByKeyValue(t,"id",r.subgroup||"nosubgroup");return n||(n={id:r.subgroup,fields:[]},t.push(n)),n.fields.push(r),t},[{id:"nosubgroup",fields:[]}]);r.data.forEach(function(t,o){var s=r.rowsMeta[o];if(!s.empty&&!s.headRow&&(i.forEach(function(n){n.nonEmptyCount=n.fields.reduce(function(n,i){return e.trim(t[r.mapping.indexOf(i.id)])?++n:n},0)}),!i[0].nonEmptyCount&&i.length>1)){var a=i.slice(1,i.length).reduce(function(e,t){return!e||t.nonEmptyCount>e.nonEmptyCount?t:e});s.subgroup=a.id;var u=e.findIndexByKeyValue(n,"subgroupKey",!0);u>=0&&!t[u]&&angular.isUndefined(s.ignore)&&(s.ignore=!0)}})}}]),angular.module("deskworks.excel",[]).service("excel",["$q","helper",function(e,t){"use strict";this.read=function(r){return e(function(e){var n=new FileReader;n.onload=function(r){var n=[],i=XLSX.read(r.target.result,{type:"binary"}),o=document.createElement("textarea");angular.forEach(i.SheetNames,function(e){for(var r=i.Sheets[e],s=function(e){for(var t=XLSX.utils.decode_range(e["!ref"]||"A1:Z1000"),r=0,n=0,i=t.e.r;i>=t.s.r;i--){for(var o=-1,s=t.e.c;s>=t.s.c;s--){var a=e[XLSX.utils.encode_cell({r:i,c:s})];if(a&&angular.isDefined(a.v)&&null!==a.v&&""!==a.v&&o<0){o=s;break}}r=r>o?r:o,o>=0&&!n&&(n=i)}return{s:{r:t.s.r,c:t.s.c},e:{r:n,c:r}}}(r),a=[],u=s.s.r;u<=s.e.r;u++){for(var d=[],c=s.s.c;c<=s.e.c;c++){var l=r[XLSX.utils.encode_cell({r:u,c:c})];d.push(t.trim((l||{}).w||""))}o.innerHTML=e,a.push(d)}n.push({name:o.value,data:a})}),e(n)},n.readAsBinaryString(r)})}}]),angular.module("deskworks.importInitMetaData",["deskworks.helper"]).factory("importInitMetaData",["helper",function(e){"use strict";return function(t){t.rowsMeta.forEach(function(r,n){r.invalid=!1,r.empty=!0,r.id=null,r.subgroup=null,r.cellsMeta.forEach(function(i,o){i.invalid=!1,r.empty=r.empty&&!e.trim(t.data[n][o])})})}}]),angular.module("deskworks.importParsers",["deskworks.helper"]).service("importParsers",["helper",function(e){"use strict";var t=this;t.options=function(t,r){return e.searchSoft(r,["name","id","import"],t)},t.bool=function(t){return!!e.trim(t).match(/^Yes|Y|true$/i)},t.int=function(t){return(t=e.trim(t).replace(/,/g,"")).length?parseInt(t):void 0},t.uint=t.int,t.float=function(t){return(t=e.trim(t).replace(/,/g,"")).length?parseFloat(t):void 0},t.currency=function(t){return(t=e.trim(t).replace(/[,\$]/g,"")).length?parseFloat(t):void 0},t.ufloat=t.float,t.date=function(t){var r;if((t=e.trim(t)).match(/(?:^(?:\s*)(?:\d{1,2})(?:\s|-|\.|\/)(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)(?:\s|-|\.|\/)(?:\d{4})(?:\s*)$)/i)?(t=t.replace(/\s|-|\.|\//g," "),r="DD MMM YYYY"):t.match(/(?:^(?:\s*)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{4})(?:\s*)$)/i)?(t=t.replace(/\s|-|\./g,"/"),r="MM/DD/YYYY"):t.match(/(?:^(?:\s*)(?:\d{4})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s*)$)/i)&&(t=t.replace(/\s|-|\./g,"-"),r="YYYY-MM-DD"),r){var n=moment(t,r);if(n.isValid())return n}}}]),angular.module("deskworks.purge.service",["ngResource","deskworks.config"]).factory("purgeService",["$resource","deskworksConfig",function(e,t){"use strict";var r=e(t.getApiAbsUrl("/purge/:entity")),n=e(t.getApiAbsUrl("/purge/centers/:centerId/:entity"));return{purgeProducts:function(e){return r.delete({entity:"products",productTypes:e}).$promise},purgePriceLists:function(e){return n.delete({centerId:e,entity:"price-lists"}).$promise},purgeMembershipTypes:function(){return r.delete({entity:"membership-types"}).$promise},purgeReservationCategories:function(){return r.delete({entity:"reservation-types"}).$promise},purgeReservationUnits:function(e){return n.delete({centerId:e,entity:"reservation-units"}).$promise},purgeMembers:function(){return r.delete({entity:"members"}).$promise}}}]),angular.module("deskworks.importSheetDetector",["deskworks.importSteps"]).service("importSheetDetector",["helper","importSteps",function(e,t){"use strict";this.detect=function(r,n){if(angular.isArray(r)&&t[n].sheetPattern)for(var i=0;i<r.length;i++)if(e.trim(r[i].name).match(t[n].sheetPattern))return r[i];return(r||[])[0]}}]),angular.module("deskworks.importStripDataComments",[]).factory("importStripDataComments",function(){"use strict";return function(e){angular.isArray(e)&&e.slice(0,5).forEach(function(e){e.forEach(function(t,r){e[r]=t.replace(/\(?PLEASE CHANGE SAMPLE DATA AS NEEDED\)?/i,"")})})}}),angular.module("deskworks.importValidateCell",["deskworks.helper"]).factory("importValidateCell",["helper",function(e){"use strict";return function(t,r,n,i,o,s,a){var u=e.findByKeyValue(o,"id",s[n]);if(u){var d=e.trim(t[r][n]);if(angular.isObject(u.type)&&u.type.options&&(u.required||""!==d)){var c;if(u.type.ref){var l=t[r][s.indexOf(u.type.ref)],p=e.findByKeyValue(o,"id",u.type.ref);l=e.searchSoft(p.type.options,["id","name","import"],l),c=a.$eval(u.type.options.replace(/\$id/g,(l||{}).id))}else c=angular.isArray(u.type.options)?u.type.options:a.$eval(u.type.options);if(angular.isArray(c)&&!e.searchSoft(c,["name","id","import"],d))return c}if(u.required){if(""===d)return u.name+" is required."}else if(""===d)return;if("uint"===u.type&&!d.match(/^\d*,?\d+$/i))return u.name+" should be a positive integer number, e.g. 100 or 0";if("int"===u.type&&!d.match(/^-?\d*,?\d+$/i))return u.name+" should be an integer number, e.g. -10 or 50";if("ufloat"===u.type&&!d.match(/^[\d,]*\.?\d+$/i))return u.name+" should be a positive number, e.g. 10 or 10.50";if("float"===u.type&&!d.match(/^-?[\d,]*\.?\d+$/i))return u.name+" should be a number, e.g. 100 or -20 or 5.5";if("bool"===u.type&&!d.match(/^Yes|No|Y|N|true|false$/i))return u.name+" should be Yes/No, Y/N, true/false";if("currency"===u.type&&!d.match(/^\$?[\d,]*\.?\d+$/i))return u.name+" should be currency, e.g. $10 or $10.50 or 12.00";if("email"===u.type&&!d.match(/^[\w\.%\+\-]+@(?:[A-Z0-9\-]+\.)+(?:[A-Z]+)$/i))return u.name+" should be valid";if("date"===u.type){var m;if(d.match(/(?:^(?:\s*)(?:\d{1,2})(?:\s|-|\.|\/)(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)(?:\s|-|\.|\/)(?:\d{4})(?:\s*)$)/i)?(d=d.replace(/\s|-|\.|\//g," "),m="DD MMM YYYY"):d.match(/(?:^(?:\s*)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{4})(?:\s*)$)/i)?(d=d.replace(/\s|-|\./g,"/"),m="MM/DD/YYYY"):d.match(/(?:^(?:\s*)(?:\d{4})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s|-|\.|\/)(?:\d{1,2})(?:\s*)$)/i)&&(d=d.replace(/\s|-|\./g,"-"),m="YYYY-MM-DD"),m&&moment(d,m).isValid())return;return u.name+" format is 06/22/2015 or 22&nbsp;Jun&nbsp;2015"}if(u.minLength&&d.length<u.minLength)return u.name+" min length is "+u.minLength;if(u.unique)if(t.filter(function(e,t){return!i[t].empty&&!i[t].ignore&&!i[t].headRow}).reduce(function(t,r){return e.trim(r[n]||"").toLowerCase()===(d||"").toLowerCase()?++t:t},0)>1)return u.name+" contains duplicate values. Must be unique.";return angular.isObject(u.type)&&u.type.pattern&&!d.match(u.type.pattern)?u.type.msg:void 0}}}]),angular.module("deskworks.importValidateData",["deskworks.helper","deskworks.importValidateCell"]).factory("importValidateData",["helper","importValidateCell",function(e,t){"use strict";return function(e,r,n){var i=0;return e.data.forEach(function(o,s){var a=e.rowsMeta[s],u=r;a.subgroup&&(u=r.filter(function(e){return e.subgroup===a.subgroup})),a.invalid=u.reduce(function(o,u){var d=e.mapping.indexOf(u.id),c=a.cellsMeta[d];return a.empty||a.headRow||a.ignore?(c.invalid=!1,o):(c.invalid=t(e.data,s,d,e.rowsMeta,r,e.mapping,n),c.invalid&&i++,o||c.invalid)},!1)}),i}}]),angular.module("deskworks.importWireData",["deskworks.helper","deskworks.importSteps"]).factory("importWireData",["helper",function(e){"use strict";return function(e,t,r,n){t.data.forEach(function(r,i){var o=t.rowsMeta[i];if(!o.empty&&!o.headRow){var s=t.mapping.reduce(function(e,t,n){return e[t]=r[n],e},{});o.id=n(e,s,o,t.rowsMeta),o.id&&angular.isUndefined(o.ignore)&&(o.ignore=!0)}})}}]),angular.module("deskworks.importStepComplete",["deskworks.state"]).component("importStepComplete",{templateUrl:"step-components/step-complete.tpl.html",controller:"ImportStepCompleteCtrl",bindings:{step:"=",purge:"<"}}).controller("ImportStepCompleteCtrl",["state",function(e){"use strict";var t=this;t.navSidebar=function(t){return t.preventDefault(),t.stopPropagation(),e.setPath(t.target.hash.replace("#",""))},t.home=function(){return e.setPath("/dashboard")},t.back=function(){t.step--}}]),angular.module("deskworks.importStepImport",["deskworks.dwAlerts","deskworks.handsontable","deskworks.importHandsontable","deskworks.importSheetDetector","deskworks.importSteps","deskworks.importInitMetaData","deskworks.importDetectSubgroups","deskworks.importWireData","deskworks.importValidateData","deskworks.importCollectStats"]).component("importStepImport",{templateUrl:"step-components/step-import.tpl.html",controller:"ImportStepImportCtrl",bindings:{step:"=",sheets:"<",purge:"<"}}).controller("ImportStepImportCtrl",["$scope","$q","$timeout","dwAlerts","state","helper","importSheetDetector","importSteps","importInitMetaData","importDetectSubgroups","importWireData","importValidateData","importCollectStats",function(e,t,r,n,i,o,s,a,u,d,c,l,p){"use strict";var m=this;m.steps=a,e.$watch("$ctrl.step",function(){if(m.step){var e=m.steps[m.step];m.fields=e.fields,m.sheet=null,t.when(e.hooks&&e.hooks.init&&e.hooks.init(m)).then(function(){m.sheet=s.detect(m.sheets,m.step)})}}),m.back=function(){m.step--},m.validateData=function(){u(m.sheet),m.fields.filter(function(e){return m.sheet.mapping.indexOf(e.id)<0}).length||(d(m,m.sheet,m.fields),c(m,m.sheet,m.fields,m.steps[m.step].hooks.wireRow),m.invalidCount=l(m.sheet,m.fields,e),m.stats=p(m.sheet.rowsMeta)),e.$broadcast("ht:render")},m.import=function(){if(m.unMappedFields.length)return n.error("Some columns unmapped. Please check red UNKNOWN markers and map them to appropriate fields.");if(m.invalidCount)return n.error(m.invalidCount+" invalid values found. Please fix them manually to proceed to the next step.");var e=m.steps[m.step],i=0,o=new PromisePool(function(){for(;i<m.sheet.data.length&&(m.sheet.rowsMeta[i].ignore||m.sheet.rowsMeta[i].subgroup||m.sheet.rowsMeta[i].headRow||m.sheet.rowsMeta[i].empty);)i++;if(i>=m.sheet.data.length)return null;var t=m.sheet.rowsMeta[i];return t.spin=!0,e.hooks.importRow(m,m.sheet.data[i++],t,m.sheet.mapping,m.fields).then(function(e){t.id=e.id||t.id,t.error=null}).catch(function(e){t.error=e.data&&e.data.error||e.status+" "+e.statusText}).finally(function(){t.spin=!1,t.ignore=!0})},5,{promise:t});return m.spin=!0,t.when(e.hooks&&e.hooks.preImport&&e.hooks.preImport(m,m.sheet,m.fields)).then(function(){return o.start()}).then(function(){return m.validateData(),r(function(){m.spin=!1,m.step++},1e3)})}}]),angular.module("deskworks.importStepInit",["ngFileUpload","deskworks.dwAlerts","deskworks.excel"]).component("importStepInit",{templateUrl:"step-components/step-init.tpl.html",controller:"ImportStepInitCtrl",bindings:{step:"=",sheets:"=",purge:"<"}}).controller("ImportStepInitCtrl",["dwAlerts","excel",function(e,t){"use strict";var r=this;r.$onInit=function(){},r.$onChanges=function(){},r.upload=function(n,i){return i&&i.length>0?e.error("Please use .xls or .xlsx files."):window.FileReader?void(n&&n.length&&t.read(n[0]).then(function(e){r.sheets=e,r.step++})):e.error("FileReader is not supported by your web browser.")}}]),angular.module("deskworks.importFieldsMembers",["deskworks.userProfile.optsCountry","deskworks.userProfile.optsState","deskworks.userProfile.optsMembershipStatus","deskworks.userProfile.optsBillingMethod"]).factory("importFieldsMembers",["optsCountry","optsState","optsMembershipStatus","optsBillingMethod",function(e,t,r,n){"use strict";return[{id:"firstName",name:"First Name",pattern:/First\s+Name/i,required:!0},{id:"lastName",name:"Last Name",pattern:/Last\s+Name/i,required:!0,type:{pattern:/^[^\\<>\/&]*$/,msg:"Last Name should not contain special characters"}},{id:"email",name:"Email",pattern:/Email/i,required:!0,unique:!0,type:"email"},{id:"company",name:"Company",pattern:/Company/i},{id:"login",name:"Login",pattern:/Login/i,required:!0,unique:!0,minLength:3,type:{pattern:/^\w[\w\.\-_@]+$/,msg:"Login should have only letters, numbers, and .-_@"}},{id:"password",name:"Password",pattern:/Password/i,required:!0,minLength:6},{id:"addressStreet",name:"Street",pattern:/Street/i,required:!0},{id:"addressCity",name:"City",pattern:/City/i,required:!0},{id:"addressCountry",name:"Country",pattern:/Country/i,required:!0,type:{options:e}},{id:"addressState",name:"State/Province",pattern:/State\s*\/\s*Province/i,required:!0,type:{options:"$ctrl.optsState.$id",ref:"addressCountry"}},{id:"addressZip",name:"Zip/Postal",pattern:/Zip\s*\/\s*Post/i,required:!0},{id:"phoneNumber",name:"Phone Number",pattern:/Number/i,required:!0,type:{pattern:/^((\+\d{1,3}[-. ]?\(?\d\)?[-. ]?\d{1,5})|(\(?\d{2,6}\)?))[-. ]?(\d{3,4})[-. ]?(\d{4})$/,msg:"Phone number examples: 888-379-2865, +1-888-379-2865, 888 379 2865, 888.379.2865"}},{id:"mailboxNumber",name:"Mailbox #",pattern:/Mailbox #/i},{id:"printerCode",name:"Printer Code",pattern:/Printer\s+Code/i},{id:"accessCode",name:"Access Code",pattern:/Access\s+Code/i},{id:"leadSource",name:"Lead Source",pattern:/Lead\s+Source/i,required:!0,type:{options:"$ctrl.leadSources"}},{id:"comments",name:"Comments",pattern:/Comments/i},{id:"billingMethod",name:"Billing Method",pattern:/Bill\s+By/i,required:!0,type:{options:n}},{id:"recurringProduct",name:"Recurring Billing",pattern:/Recurring\s+Billing/i,type:{options:"$ctrl.products"},subgroup:"recurring",subgroupKey:!0},{id:"recurringQuantity",name:"Qty",pattern:/Qty/i,type:"uint",subgroup:"recurring"},{id:"recurringDiscount",name:"Discount",pattern:/^Discount/i,type:"currency",subgroup:"recurring"},{id:"recurringMonthsOfDiscount",name:"Months of Discount",pattern:/Months\s+of\s+Discount/i,type:"uint",subgroup:"recurring"},{id:"recurringAttachedReservationUnit",name:"Attached Reservation Unit",pattern:/Make\s+Matching\s+Reservation\s+Unit\s+Unavailable/i,unique:!0,type:{options:"$ctrl.reservationUnits"},subgroup:"recurring"},{id:"recurringNextBillDate",name:"Next Bill Date",pattern:/Next\s+Bill\s+Date/i,type:"date",subgroup:"recurring"}]}]),angular.module("deskworks.importFieldsMembershipProducts",[]).factory("importFieldsMembershipProducts",function(){"use strict";return[{id:"name",name:"Product Name",pattern:/Product\s+Name/i,required:!0,unique:!0},{id:"membershipCategory",name:"Membership Category",pattern:/Membership\s+Category/i,required:!0},{id:"isCreditable",name:"Has Reservation Credit?",pattern:/Has\s+Reservation\s+Credit/i,type:"bool"},{id:"hasPasses",name:"Has Passes?",pattern:/Has\s+Passes/i,type:"bool"},{id:"passProduct",name:"Product to use for pass",pattern:/Product.+for.+pass/i,type:{options:"$ctrl.productsRental"}},{id:"showInSelfRegistration",name:"Show for Self-Registration",pattern:/Show.+Self.*Regis/i,type:"bool"},{id:"itemCategory",name:"Part Number Category",pattern:/Part\s+Number\s+Category/i,required:!0,type:"uint"},{id:"itemNumber",name:"Part Number Code",pattern:/Part\s+Number\s+Code/i,required:!0,type:"uint"},{id:"price",name:"Price",pattern:/^Price/i,required:!0,type:"currency"},{id:"reservationCredit",name:"Reservation Credit",pattern:/^Reservation\s+Credit/i,type:"currency"},{id:"passQty",name:"Passes",pattern:/^Passes/i,type:"uint"},{id:"description",name:"Description",pattern:/Description/i}]}),angular.module("deskworks.importFieldsOtherProducts",["deskworks.inventory.optsProductType"]).factory("importFieldsOtherProducts",["optsProductType",function(e){"use strict";return[{id:"name",name:"Product Name",pattern:/Product\s+Name/i,required:!0,unique:!0},{id:"type",name:"Product Type",pattern:/Product\s+Type/i,required:!0,type:{options:e.filter(function(e){return"membership"!==e.id})}},{id:"allowReservationCredits",name:"Can use Reservation Credits",pattern:/Can\s+use\s+Reservation\s+Credit/i,type:"bool"},{id:"passSize",name:"Pass Size",pattern:/Pass\s+Size/i,type:"uint"},{id:"reservationCategory",name:"Reservation Category",pattern:/Reservation\s+Category/i,type:{options:"$ctrl.reservationCategories"}},{id:"itemCategory",name:"Part Number Category",pattern:/Part\s+Number\s+Category/i,required:!0,type:"uint"},{id:"itemNumber",name:"Part Number Code",pattern:/Part\s+Number\s+Code/i,required:!0,type:"uint"},{id:"monthlyPrice",name:"Monthly Members Price List",pattern:/Monthly\s+Members\s+Price\s?list/i,type:"currency"},{id:"walkinPrice",name:"Walkin Price List",pattern:/Walkin\s+Price\s?list/i,type:"currency"},{id:"description",name:"Product Description",pattern:/^Product\s+Description/i}]}]),angular.module("deskworks.importFieldsReservationCategories",[]).factory("importFieldsReservationCategories",function(){"use strict";return[{id:"name",name:"Reservation Category",pattern:/^Reservation\s+Category/i,required:!0,unique:!0},{id:"description",name:"Description",pattern:/^Description/i}]}),angular.module("deskworks.importFieldsReservationUnits",["deskworks.reservationRules.optsWhoCanReserve"]).factory("importFieldsReservationUnits",["optsWhoCanReserve",function(e){"use strict";return[{id:"name",name:"Reservation Unit",pattern:/^Reservation\s+Unit$/i,required:!0,unique:!0},{id:"reservationCategory",name:"Reservation Category",pattern:/^Reservation\s+Category$/i,required:!0,type:{options:"$ctrl.reservationCategories"}},{id:"whoCanReserve",name:"Who can reserve?",pattern:/^Who\s+can\s+reserve/i,required:!0,type:{options:e}},{id:"fullTimeProduct",name:"Full-time Product",pattern:/^Full-time\s+Product/i,type:{options:"$ctrl.productsMembership"}}]}]),angular.module("deskworks.importHooksMembers",["deskworks.dwAlerts","deskworks.helper","deskworks.state","deskworks.importParsers","deskworks.inventory.product.service","deskworks.inventory.priceList.service","deskworks.inventory.membershipCategory.service","deskworks.system.service","deskworks.userProfile.service","deskworks.recurringCharge.service","deskworks.reservationUnit.service","deskworks.userProfile.optsMembershipStatus","deskworks.userProfile.optsState","deskworks.billing.optsDiscountType"]).factory("importHooksMembers",["$q","$filter","dwAlerts","helper","state","importParsers","productService","priceListService","membershipCategoryService","systemService","userProfileService","RecurringCharge","reservationUnitService","optsMembershipStatus","optsState","optsDiscountType",function(e,t,r,n,i,o,s,a,u,d,c,l,p,m,h,f){"use strict";return{init:function(t){return e.all([s.getProducts().catch(function(e){return r.error(e,"Failed to query products.")}).then(function(e){t.products=e.filter(function(e){return"membership"===e.type||"services"===e.type})}),d.getLeadSources().catch(function(e){return r.error(e,"Failed to query lead sources.")}).then(function(e){t.leadSources=e}),c.query(0,{activeMembers:!0,inactiveMembers:!0,activeCoMembers:!0,inactiveCoMembers:!0,nonMembers:!0}).catch(function(e){return r.error(e,"Failed to query all users.")}).then(function(e){t.users=e}),c.query(i.getCurrentCenterId(),{activeMembers:!0}).catch(function(e){return r.error(e,"Failed to query members.")}).then(function(e){t.members=e}),a.getPricelists(i.getCurrentCenterId()).catch(function(e){return r.error(e,"Failed to query price lists.")}).then(function(e){return t.monthlyPriceList=n.findByKeyValue(e,"name","Monthly Plans"),a.getPricelist(i.getCurrentCenterId(),t.monthlyPriceList.id).then(function(e){t.monthlyPriceList=e})}),p.getReservationUnits(i.getCurrentCenterId()).catch(function(e){return r.error(e,"Failed to query reservation units")}).then(function(e){t.reservationUnits=e})])},importRow:function(r,s,a,u,p){var g=n.findByKeyValue(p,"id","billingMethod").type.options,y=n.findByKeyValue(p,"id","addressCountry").type.options,v=u.indexOf("recurringProduct"),w={id:a.id||void 0,firstName:n.trim(s[u.indexOf("firstName")]),lastName:n.trim(s[u.indexOf("lastName")]),company:n.trim(s[u.indexOf("company")]),login:n.trim(s[u.indexOf("login")]),password:n.trim(s[u.indexOf("password")]),passwordConfirmation:n.trim(s[u.indexOf("password")]),email:n.trim(s[u.indexOf("email")]),comments:n.trim(s[u.indexOf("comments")]),leadSource:o.options(s[u.indexOf("leadSource")],r.leadSources),membershipStatus:n.findByKeyValue(m,"id","nonMember"),membershipBillingMethod:o.options(s[u.indexOf("billingMethod")],g)},k=[],C=r.sheet.data.indexOf(s),b=C;for(;b<r.sheet.data.length&&(r.sheet.rowsMeta[b].subgroup||b===C||r.sheet.rowsMeta[b].headRow||r.sheet.rowsMeta[b].empty);){var P=r.sheet.rowsMeta[b],S=r.sheet.data[b];if(!P.ignore&&!P.headRow&&!P.empty&&n.trim(S[v])){var x=l.new();x.priceListProduct={};var M=o.options(S[v],r.products)||{};x.priceListProduct.id=n.findByKeyValue(r.monthlyPriceList.products,"productId",M.id).id,x.priceListProduct.productId=M.id,x.priceListProduct.priceListId=r.monthlyPriceList.id,x.name=M.name,x.nextBillDate=o.date(S[u.indexOf("recurringNextBillDate")])||moment(),x.quantity=o.uint(S[u.indexOf("recurringQuantity")])||1,x.discountValue=o.currency(S[u.indexOf("recurringDiscount")]),x.discountValue&&(x.discountType=f[1],x.discountTrialOccurrences={id:o.uint(S[u.indexOf("recurringMonthsOfDiscount")])||1}),x.attachedReservationUnitId=(o.options(S[u.indexOf("recurringAttachedReservationUnit")],r.reservationUnits)||{}).id,k.push(x)}b++}k.length&&(w.membershipProduct=o.options(k[0].name,r.products),w.membershipStatus=n.findByKeyValue(m,"id","active"),w.membershipType={id:w.membershipProduct.membershipTypeId},w.membershipPriceList=r.monthlyPriceList);var R=c.address.new();R.street=n.trim(s[u.indexOf("addressStreet")]),R.city=n.trim(s[u.indexOf("addressCity")]),R.country=o.options(s[u.indexOf("addressCountry")],y),R.state=h[R.country.id]?o.options(s[u.indexOf("addressState")],h[R.country.id]):n.trim(s[u.indexOf("addressState")]),R.zip=n.trim(s[u.indexOf("addressZip")]);var $=c.phone.new();$.number=n.trim(s[u.indexOf("phoneNumber")]);var I=c.printerCode.new();I.code=n.trim(s[u.indexOf("printerCode")]);var A=c.mailbox.new();A.number=n.trim(s[u.indexOf("mailboxNumber")]);var O={number:n.trim(s[u.indexOf("accessCode")]),effectiveDate:t("date")(moment(),"yyyy-MM-dd")};return c.save(i.getCurrentCenterId(),w).then(function(){if(a.id)return w.membershipProduct?l.query(i.getCurrentCenterId(),w.id).then(function(t){return e.all(k.map(function(e){return e.id=(n.findByKeyValue(t,"productName",e.name)||{}).id||e.id,l.save(i.getCurrentCenterId(),w.id,e)})).then(function(){return w})}):w;var t=[];return t.push(c.address.save(i.getCurrentCenterId(),w.id,R)),t.push(c.phone.save(i.getCurrentCenterId(),w.id,$)),""!==I.code&&t.push(c.printerCode.save(i.getCurrentCenterId(),w.id,I)),""!==A.number&&t.push(c.mailbox.save(i.getCurrentCenterId(),w.id,A)),""!==O.number&&(O.userId=w.id,t.push(d.createAccessCard(i.getCurrentCenterId(),O))),k.forEach(function(e){t.push(l.save(i.getCurrentCenterId(),w.id,e))}),e.all(t).then(function(){return w})})},wireRow:function(e,t,r,i){if("recurring"===r.subgroup){for(var o=i.indexOf(r)-1;o>=0&&(i[o].empty||i[o].headRow||i[o].subgroup);)o--;return r.ignore=r.ignore||i[o].ignore,r.id=i[o].id,r.id}if(r.id=(n.findByKeyValue(e.users,"fullName",t.firstName+" "+t.lastName)||{}).id||null,r.id){var s=!!n.findByKeyValue(e.members,"fullName",t.firstName+" "+t.lastName);!s&&t.recurringProduct&&angular.isUndefined(r.ignore)&&(r.ignore=!1)}return r.id}}}]),angular.module("deskworks.importHooksMembershipProducts",["keese","deskworks.dwAlerts","deskworks.helper","deskworks.state","deskworks.importParsers","deskworks.inventory.product.service","deskworks.inventory.priceList.service","deskworks.inventory.membershipCategory.service"]).factory("importHooksMembershipProducts",["$q","dwAlerts","helper","state","importParsers","keese","productService","priceListService","membershipCategoryService",function(e,t,r,n,i,o,s,a,u){"use strict";return{init:function(i){return e.all([s.getProducts().catch(function(e){return t.error(e,"Failed to get products.")}).then(function(e){i.products=e.filter(function(e){return"membership"===e.type}),i.productsRental=e.filter(function(e){return"rental"===e.type})}),(o=i,d={name:"Monthly Plans",visibleForVisitors:!0,useFor:"members"},a.getPricelists(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to get price lists.")}).then(function(e){var i=r.findByKeyValue(e,"name",d.name);return i||a.save(n.getCurrentCenterId(),d).catch(function(e){return t.error(e,'Failed to create "'+d.name+'" price list.')}).then(function(){return d})}).then(function(e){return a.getPricelist(n.getCurrentCenterId(),e.id).catch(function(r){return t.error(r,"Failed to get price list "+e.name+".")})}).then(function(e){o.monthlyPriceList=e})),u.query().catch(function(e){return t.error(e,"Failed to get membership categories.")}).then(function(e){i.membershipCategories=angular.copy(e)})]);var o,d},preImport:function(n,s,a){var d=[];return s.data.forEach(function(e,a){var c=s.rowsMeta[a];if(!(c.ignore||c.headRow||c.empty)){var l=r.trim(e[s.mapping.indexOf("membershipCategory")]),p=i.options(l,n.membershipCategories);p||(p={name:l,order:o.generate(n.membershipCategories.length&&n.membershipCategories[n.membershipCategories.length-1].order),note:r.trim(e[s.mapping.indexOf("description")])},n.membershipCategories.push(p),d.push(u.save(p).catch(function(e){return t.error(e,"Failed to create membership category.")})))}}),e.all(d)},importRow:function(e,t,n,o,a){var u=s.new();return u.id=n.id||void 0,u.name=r.trim(t[o.indexOf("name")]),u.membershipType=i.options(t[o.indexOf("membershipCategory")],e.membershipCategories),u.isCreditable=i.bool(t[o.indexOf("isCreditable")]),u.hasPasses=i.bool(t[o.indexOf("hasPasses")]),u.passProduct=i.options(t[o.indexOf("passProduct")],e.productsRental),u.hideInSelfRegistration=!i.bool(t[o.indexOf("showInSelfRegistration")]),u.itemCategory=i.uint(t[o.indexOf("itemCategory")]),u.itemNumber=i.uint(t[o.indexOf("itemNumber")]),u.description=r.trim(t[o.indexOf("description")]),s.save(u).then(function(t){!n.id&&t.id&&e.products.push(u)}).then(function(){var n={id:(r.findByKeyValue(e.monthlyPriceList.products,"productId",u.id)||{}).id,priceListId:e.monthlyPriceList.id,price:i.currency(t[o.indexOf("price")]),reservationCredit:u.isCreditable?i.currency(t[o.indexOf("reservationCredit")]):void 0,passQty:u.hasPasses?i.uint(t[o.indexOf("passQty")]):void 0};return s.savePriceItem(u.id,n).then(function(){r.findByKeyValue(e.monthlyPriceList.products,"productId",u.id)||e.monthlyPriceList.products.push(n)})}).then(function(){return u})},wireRow:function(e,t,n){if(n.id=(r.findByKeyValue(e.products,"name",t.name)||{}).id||null,n.id){var o=r.findByKeyValue(e.monthlyPriceList.products,"productId",n.id)||{};o.price!=i.currency(t.price)&&angular.isUndefined(n.ignore)&&(n.ignore=!1)}return n.id}}}]),angular.module("deskworks.importHooksOtherProducts",["deskworks.dwAlerts","deskworks.helper","deskworks.state","deskworks.importParsers","deskworks.inventory.product.service","deskworks.inventory.priceList.service","deskworks.reservationCategory.service"]).factory("importHooksOtherProducts",["$q","dwAlerts","helper","state","importParsers","productService","priceListService","reservationCategoryService",function(e,t,r,n,i,o,s,a){"use strict";return{init:function(i){return e.all([o.getProducts().catch(function(e){return t.error(e,"Failed to get products.")}).then(function(e){i.products=e.filter(function(e){return"membership"!==e.type})}),(u=i,d=[{name:"Monthly Plans",visibleForVisitors:!0,useFor:"members"},{name:"Walkin",visibleForVisitors:!0,useFor:"nonMembers"}],s.getPricelists(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to get price lists.")}).then(function(i){return e.all(d.map(function(e){var o=r.findByKeyValue(i,"name",e.name);return o||s.save(n.getCurrentCenterId(),e).catch(function(r){return t.error(r,'Failed to create "'+e.name+'" price list.')}).then(function(){return e})}))}).then(function(r){return e.all(r.map(function(e,r){return s.getPricelist(n.getCurrentCenterId(),e.id).catch(function(r){return t.error(r,"Failed to get price list "+e.name+".")})}))}).then(function(e){u.monthlyPriceList=e[0],u.walkinPriceList=e[1]})),a.query(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to load reservation categories.")}).then(function(e){i.reservationCategories=e})]);var u,d},importRow:function(t,n,s,a,u){var d=o.new();return d.id=s.id||void 0,d.name=r.trim(n[a.indexOf("name")]),d.type=i.options(n[a.indexOf("type")],r.findByKeyValue(u,"id","type").type.options),d.allowReservationCredits=i.bool(n[a.indexOf("allowReservationCredits")]),d.passSize=i.uint(n[a.indexOf("passSize")]),d.itemCategory=i.uint(n[a.indexOf("itemCategory")]),d.itemNumber=i.uint(n[a.indexOf("itemNumber")]),d.description=r.trim(n[a.indexOf("description")]),d.reservationTypeId=(i.options(n[a.indexOf("reservationCategory")],t.reservationCategories)||{}).id,o.save(d).then(function(e){return!s.id&&e.id&&t.products.push(d),e}).then(function(){var s={id:(r.findByKeyValue(t.monthlyPriceList.products,"productId",d.id)||{}).id,priceList:t.monthlyPriceList,priceListId:t.monthlyPriceList.id,price:i.currency(n[a.indexOf("monthlyPrice")])},u={id:(r.findByKeyValue(t.walkinPriceList.products,"productId",d.id)||{}).id,priceList:t.walkinPriceList,priceListId:t.walkinPriceList.id,price:i.currency(n[a.indexOf("walkinPrice")])};return e.all([s,u].filter(function(e){return e.price||0==e.price}).map(function(e){var t=e.priceList;return delete e.priceList,o.savePriceItem(d.id,e).then(function(){r.findByKeyValue(t.products,"productId",d.id)||t.products.push(e)})})).then(function(){return d})})},wireRow:function(e,t,n){if(n.id=(r.findByKeyValue(e.products,"name",t.name)||{}).id||null,n.id){var o=r.findByKeyValue(e.monthlyPriceList.products,"productId",n.id)||{};o.price!=i.currency(t.monthlyPrice)&&angular.isUndefined(n.ignore)&&(n.ignore=!1);var s=r.findByKeyValue(e.monthlyPriceList.products,"productId",n.id)||{};s.price!=i.currency(t.walkinPrice)&&angular.isUndefined(n.ignore)&&(n.ignore=!1)}return n.id}}}]),angular.module("deskworks.importHooksReservationCategories",["deskworks.dwAlerts","deskworks.helper","deskworks.state","deskworks.reservationCategory.service"]).factory("importHooksReservationCategories",["dwAlerts","helper","state","reservationCategoryService",function(e,t,r,n){"use strict";return{init:function(t){return n.query(r.getCurrentCenterId()).catch(function(t){return e.error(t,"Failed to load reservation categories.")}).then(function(e){t.reservationCategories=e})},importRow:function(e,i,o,s){var a={id:o.id||void 0,name:t.trim(i[s.indexOf("name")]),description:t.trim(i[s.indexOf("description")])};return n.save(r.getCurrentCenterId(),a).then(function(t){return!o.id&&t.id&&e.reservationCategories.push({id:t.id,name:a.name}),t})},wireRow:function(e,r){return(t.findByKeyValue(e.reservationCategories,"name",r.name)||{}).id||null}}}]),angular.module("deskworks.importHooksReservationUnits",["deskworks.dwAlerts","deskworks.helper","deskworks.state","deskworks.importParsers","deskworks.reservationRules.service","deskworks.reservationCategory.service","deskworks.reservationUnit.service","deskworks.inventory.product.service","deskworks.reservationRules.optsWhoCanReserve"]).factory("importHooksReservationUnits",["$q","dwAlerts","helper","state","importParsers","ReservationRules","reservationCategoryService","reservationUnitService","productService","optsWhoCanReserve",function(e,t,r,n,i,o,s,a,u,d){"use strict";return{init:function(r){return e.all([s.query(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to load reservation categories.")}).then(function(e){r.reservationCategories=e}),a.getReservationUnits(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to load reservation units.")}).then(function(e){r.reservationUnits=e}),u.getMembershipProducts(n.getCurrentCenterId()).catch(function(e){return t.error(e,"Failed to load membership products.")}).then(function(e){r.productsMembership=e})])},importRow:function(e,t,s,u,c){var l={id:s.id||void 0,name:r.trim(t[u.indexOf("name")]),reservationTypeId:(i.options(t[u.indexOf("reservationCategory")],e.reservationCategories)||{}).id,fullTimeProductId:(i.options(t[u.indexOf("fullTimeProduct")],e.productsMembership)||{}).id};return a.save(n.getCurrentCenterId(),l).then(function(t){return!s.id&&t.id&&e.reservationUnits.push({id:t.id,name:l.name}),t}).then(function(e){return o.query({centerId:n.getCurrentCenterId(),reservationUnitId:l.id}).then(function(e){var s=r.findByKeyValue(e,"uid","whoCanReserve");return s.value=(i.options(t[u.indexOf("whoCanReserve")],d)||{}).id,o.save({centerId:n.getCurrentCenterId(),reservationUnitId:l.id},s)}).then(function(){return e})})},wireRow:function(e,t){return(r.findByKeyValue(e.reservationUnits,"name",t.name)||{}).id||null}}}]);