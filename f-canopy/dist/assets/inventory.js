angular.module("deskworks.inventory.membershipCategory.edit",["keese","deskworks.inventory.membershipCategory.service"]).controller("MembershipCategoryEditCtrl",["$scope","$route","$translate","dwAlerts","keese","state","helper","membershipCategories","membershipCategoryService",function(e,t,r,n,i,o,s,a,c){"use strict";var d=this;d.category=s.findByKeyValue(a,"id",t.current.params.membershipCategoryId)||{},"new"===t.current.params.membershipCategoryId&&(d.category.id="new"),o.setPageTitle(r.instant("new"===d.category.id?"MEMBERSHIP_CATEGORIES.NEW.PAGE_TITLE":"MEMBERSHIP_CATEGORIES.EDIT.PAGE_TITLE")),d.save=function(e){if(!s.pointFirstInvalid("#membershipCategory")){var t,r={name:d.category.name,note:d.category.note};return"new"===d.category.id?(r.order=i.generate(a[a.length-1]&&a[a.length-1].order),t=c.create(r)):t=c.update(d.category.id,r),t.catch(function(e){return n.error(e,"Failed to save membership category.")}).then(function(t){if(e.$setPristine(!0),"new"===d.category.id)return o.setPath("/membership-types/"+t.id)})}},d.remove=function(){if(confirm(r.instant("MEMBERSHIP_CATEGORIES.CONFIRM_DELETE")))return c.delete(d.category.id).catch(function(e){return n.error(e,"Failed to remove membership category.")}).then(function(){return o.setPath("/membership-types")})},d.back=function(){return o.setPath("/membership-types")}}]),angular.module("deskworks.inventory.membershipCategory.list",["dnd","deskworks.inventory.membershipCategory.service"]).controller("MembershipCategoryListCtrl",["$scope","$translate","state","dnd","helper","dwAlerts","membershipCategories","membershipCategoryService",function(e,t,r,n,i,o,s,a){"use strict";var c=this;r.setPageTitle(t.instant("MEMBERSHIP_CATEGORIES.PAGE_TITLE")),c.membershipCategories=s,c.edit=function(e){return r.setPath("/membership-types/"+e.id)},c.new=function(){return r.setPath("/membership-types/new")},c.onDrop=function(e,t,r,i){var s=n.move(e,t,r,i);return s.$spin=!0,a.update(s.id,{order:s.order}).catch(function(e){return o.error(e,"Failed to reorder membership category.")}).finally(function(){delete s.$spin}),!0}}]),angular.module("deskworks.inventory.priceList.edit",["deskworks.inventory.priceList.service"]).controller("PriceListEditCtrl",["$scope","$rootScope","$filter","$timeout","$translate","dwAlerts","state","helper","priceList","priceListService","optsProductType",function(e,t,r,n,i,o,s,a,c,d,u){"use strict";var p=this;s.setPageTitle(i.instant("new"===c.id?"PRICE_LISTS.NEW.PAGE_TITLE":"PRICE_LISTS.EDIT.PAGE_TITLE")),p.priceList=c,p.useForOptions=[{id:"members",name:i.instant("PRICE_LISTS.USE_FOR.MEMBERS")},{id:"nonMembers",name:i.instant("PRICE_LISTS.USE_FOR.NON_MEMBERS")},{id:"none",name:i.instant("PRICE_LISTS.USE_FOR.NONE")}],p.priceList.useFor=a.findByKeyValue(p.useForOptions,"id",p.priceList.useFor),p.productTypes=angular.copy(u),p.productTypes.forEach(function(e){e.products=[],e.options=[]}),p.priceList.options.products.forEach(function(e){var t=a.findByKeyValue(p.productTypes,"id",e.type);t?t.options.push(e):console.warn("Product option of unknown type:",e)}),p.priceList.products.forEach(function(e){e.product=a.findByKeyValue(p.priceList.options.products,"id",e.productId),e.price=r("price")(e.price),angular.isDefined(e.reservationCredit)&&(e.reservationCredit=r("price")(e.reservationCredit)),null===e.passQty&&(e.passQty=0);var t=a.findByKeyValue(p.productTypes,"id",e.product.type);t?t.products.push(e):console.warn("Product of unknown type:",e)}),p.remove=function(){if(confirm(i.instant("PRICE_LISTS.CONFIRM_DELETE")))return d.deletePricelist(s.getCurrentCenterId(),p.priceList.id).then(function(){return s.setPath("/pricelists")}).catch(function(e){return o.error(e,"Failed to remove price list.")})},p.save=function(){if(!a.pointFirstInvalid("#priceListEdit")){var e={name:p.priceList.name,visibleForVisitors:p.priceList.visibleForVisitors,useFor:p.priceList.useFor?p.priceList.useFor.id:p.priceList.useFor};return("new"===p.priceList.id?d.createPricelist(s.getCurrentCenterId(),e):d.updatePricelist(s.getCurrentCenterId(),p.priceList.id,e)).then(function(e){if(p.priceList.date=moment(),p.form.$setPristine(),"new"===p.priceList.id)return s.setPath("/pricelists/"+e.id)}).catch(function(e){return o.error(e,"Failed to save price list.")})}},p.back=function(){return s.setPath("/pricelists")},p.addProduct=function(e){if(!e.options.length)return o.error(i.instant("PRICE_LISTS.NO_PRODUCTS_ERROR"));var t={id:"new",productId:e.options[0].id,product:e.options[0],price:"",passQty:0};e.products.push(t),n(function(){var t=document.querySelector("#productType-"+e.id+" form:last-of-type");t&&(t=t.querySelector("select:first-of-type"))&&t.focus()})},p.saveProduct=function(e,t,r){if(!a.pointFirstInvalid("#productForm-"+r)){var n={productId:e.product.id,price:e.price};return e.product.isCreditable&&(n.reservationCredit=e.reservationCredit),e.product.hasPasses&&(n.passQty=e.passQty),("new"===e.id?d.createProduct(s.getCurrentCenterId(),p.priceList.id,n):d.updateProduct(s.getCurrentCenterId(),p.priceList.id,e.id,n)).then(function(r){"new"===e.id&&(e.id=r.id),t.$setPristine()}).catch(function(e){return o.error(e,"Failed to save product.")})}},p.removeProduct=function(e,t,r){if("new"!==e.id)return d.deleteProduct(s.getCurrentCenterId(),p.priceList.id,e.id).then(function(){r.products.splice(t,1)}).catch(function(e){return o.error(e,"Failed to remove product.")});r.products.splice(t,1)},e.$watch("state.getCurrentCenterId()",function(e,t){e!==t&&s.setPath("/pricelists")})}]),angular.module("deskworks.inventory.priceList.list",["deskworks.inventory.priceList.service"]).controller("PriceListListCtrl",["$rootScope","$scope","$timeout","$route","$ocLazyLoad","$translate","dwAlerts","state","helper","priceLists","centers","priceListService",function(e,t,r,n,i,o,s,a,c,d,u,p){"use strict";var l=this;a.setPageTitle(o.instant("PRICE_LISTS.PAGE_TITLE")),l.centers=u,l.dstCenterId=a.getCurrentCenterId(),l.priceLists=d,l.priceLists.forEach(function(e){e.include=!0}),l.editAfterCloning=!0,l.printCollapsed=!0,l.edit=function(e){return a.setPath("/pricelists/"+e.id)},l.clone=function(e){if(!(l.centers.length>1)||l.cloning)return p.clonePricelist(a.getCurrentCenterId(),e.id,l.dstCenterId).then(function(e){return l.editAfterCloning?(a.setCurrentCenterId(l.dstCenterId),a.setPath("/pricelists/"+e.id)):(n.reload(),r(5e3))}).catch(function(e){return s.error(e,"Failed to copy price list.")});l.cloning=e},l.new=function(){return a.setPath("/pricelists/new")},l.togglePrint=function(){return i.load("reports").then(function(){l.printCollapsed=!l.printCollapsed}).catch(function(e){console.error("$ocLazyLoad error:",e)})},e.$on("CHANGE-CENTER",function(){n.reload()})}]),angular.module("deskworks.inventory.product.edit",["deskworks.inventory.product.service","deskworks.inventory.optsCountCheckInsPer","deskworks.printerUsageTypeNames"]).controller("ProductEditCtrl",["$scope","$window","$translate","$q","dwAlerts","state","helper","product","settings","productService","optsPassMin","optsPassMax","optsCountCheckInsPer","printerUsageTypeNames","productCategories",function(e,t,r,n,i,o,s,a,c,d,u,p,l,v,h){"use strict";var f=this;o.setPageTitle(r.instant(a.id?"PRODUCTS.EDIT.PAGE_TITLE":"PRODUCTS.NEW.PAGE_TITLE")),f.product=a,f.optsPassMin=u,f.optsPassMax=p,f.optsCountCheckInsPer=l,f.printerUsageTypeNames=v,f.productCategories=h.filter(function(e){return"0-00"!==e.code}),f.productCategories.forEach(function(e){e.fullName=s.join([e.name,"["+e.code+"]"]," ")}),f.passMinUnit=c.minPassInPercent?"pass":"time",c.minPassInPercent||(f.optsPassMin=angular.copy(f.optsPassMin),f.optsPassMin.forEach(function(e){e.name+=" hr"})),f.product.options.passProducts=[],d.getProducts().then(function(e){angular.isArray(e)&&(e.forEach(function(e){"rental"===e.type&&f.product.options.passProducts.push(e)}),f.product.passProduct=s.findByKeyValue(f.product.options.passProducts,"id",f.product.passProductId))}),f.save=function(e){if(!s.pointFirstInvalid("#productEdit"))return(f.product.id?n.all([d.updateProduct(f.product).catch(function(e){return i.error(e,"Failed to save product.")}),n.when(f.saveQuickBooks&&f.saveQuickBooks())]):d.createProduct(f.product).catch(function(e){return i.error(e,"Failed to save product.")})).then(function(t){if(e.$setPristine(!0),!f.product.id)return o.setPath("/products/"+t.id)})},f.remove=function(){if(confirm(r.instant("PRODUCTS.CONFIRM_DELETE")))return d.deleteProduct(f.product.id).catch(function(e){return i.error(e,"Failed to remove product.")}).then(function(){return o.setPath("/products")})},f.back=function(){return o.setPath("/products")},f.addPriceList=function(){var e=s.uid();f.product.priceLists.push({id:e,priceListsId:f.product.options.priceLists[0].id,priceList:f.product.options.priceLists[0],price:"",passQty:0}),s.focus("#productPriceList-"+e+" select:first-of-type")},f.savePriceList=function(e,t){if(!s.pointFirstInvalid("#productPriceList-"+e.id)){var r={priceListId:e.priceList.id,price:e.price};return f.product.isCreditable&&(r.reservationCredit=e.reservationCredit),f.product.hasPasses&&(r.passQty=e.passQty),(s.isUid(e.id)?d.createPriceList(f.product.id,r):d.updatePriceList(f.product.id,e.id,r)).catch(function(e){return i.error(e,"Failed to save price list.")}).then(function(r){return s.isUid(e.id)&&(e.id=r.id),t.$setPristine(!0),r})}},f.removePriceList=function(e,t){if(!s.isUid(e.id))return d.deletePriceList(f.product.id,e.id).catch(function(e){return i.error(e,"Failed to remove price list.")}).then(function(e){return f.product.priceLists.splice(t,1),e});f.product.priceLists.splice(t,1)}}]),angular.module("deskworks.inventory.product.list",["deskworks.inventory.product.service"]).controller("ProductListCtrl",["$scope","$translate","state","helper","products","productService","optsProductType",function(e,t,r,n,i,o,s){"use strict";var a=this;r.setPageTitle(t.instant("PRODUCTS.PAGE_TITLE")),a.collapsed=!0,a.productTypes=angular.copy(s),a.productTypes.forEach(function(e){e.products=[]}),a.customProducts={id:"custom",name:t.instant("PRODUCTS.LIST.CUSTOM"),products:[]},i.forEach(function(e){var t=n.findByKeyValue(a.productTypes,"id",e.type);e.custom?a.customProducts.products.push(e):t?t.products.push(e):console.warn("Product of unknown type:",e)}),a.edit=function(e){return r.setPath("/products/"+e.id)},a.new=function(){return r.setPath("/products/new")}}]),angular.module("deskworks.ProductCategoriesCtrl",["debounce","deskworks.ProductCategory"]).controller("ProductCategoriesCtrl",["$scope","$translate","dwAlerts","state","helper","debounce","categories","ProductCategory",function(e,t,r,n,i,o,s,a){"use strict";var c=this;n.setPageTitle(t.instant("PRODUCT_CATEGORIES.PAGE_TITLE")),c.categories=s,c.save=o(function(e,t,n){if(t.$invalid)return;return e.$$spin=!0,a.save(e).catch(function(e){return r.error(e,"Failed to save product category.")}).finally(function(){e.$$spin=!1})},1e3),c.new=function(){c.categories.push({})},c.delete=function(e,t){if(e.id)return e.$$spin=!0,a.delete(e.id).catch(function(e){return r.error(e,"Failed to delete product category.")}).then(function(){c.categories.splice(t,1)}).finally(function(){e.$$spin=!1});c.categories.splice(t,1)}}]),angular.module("deskworks.inventory.reservationCategory",["keese","textAngular","deskworks.helper","deskworks.reservationCategory.service"]).controller("InventoryReservationCategoryEditCtrl",["$scope","$window","$translate","keese","dwAlerts","state","helper","reservationCategory","reservationCategories","reservationCategoryService",function(e,t,r,n,i,o,s,a,c,d){"use strict";var u=this;if(o.setPageTitle(r.instant("new"===a.id?"RESERVATION_CATEGORIES.NEW.PAGE_TITLE":"RESERVATION_CATEGORIES.EDIT.PAGE_TITLE")),u.category=a,u.hours=[0,1,2,24,48,72,120,168],u.category.photos){var p=s.findIndexByKeyValue(u.category.photos,"id",null);p>=0&&u.category.photos.splice(p,1)}u.save=function(e){var t,r={name:u.category.name,description:u.category.description,cancellationNonMemberNoticeHours:u.category.cancellationNonMemberNoticeHours,cancellationMemberNoticeHours:u.category.cancellationMemberNoticeHours};return"new"===u.category.id?(r.order=n.generate(c[c.length-1]&&c[c.length-1].order),t=d.create(o.getCurrentCenterId(),r)):t=d.update(o.getCurrentCenterId(),u.category.id,r),t.then(function(t){if(e.$setPristine(),"new"===u.category.id)return o.setPath("/reservation-types/"+t.id)}).catch(function(e){return i.error(e,"Failed to save reservation category.")})},u.remove=function(){if(t.confirm(r.instant("RESERVATION_CATEGORIES.CONFIRM_DELETE")))return d.delete(o.getCurrentCenterId(),u.category.id).then(function(){return o.setPath("/reservation-types")}).catch(function(e){return i.error(e,"Failed to remove reservation category.")})},u.back=function(){return o.setPath("/reservation-types")},u.uploadPhoto=function(e,t,n){return t&&t.length>0?i.error(r.instant("GLOBAL.PHOTO.INVALID_FORMAT")):e&&e.length>0?(n?(s=d.updatePhoto(o.getCurrentCenterId(),u.category.id,n.id,e[0]),n.spin=!0):(s=d.createPhoto(o.getCurrentCenterId(),u.category.id,e[0]),u.spinAddPhoto=!0),s.then(function(e){n?n.url=e.data.url:u.category.photos.push({id:e.data.id,url:e.data.url})}).catch(function(e){return i.error(e,"Failed to upload reservation category photo.")}).finally(function(){u.spinAddPhoto=!1,n&&(n.spin=!1)})):void 0;var s},u.removePhoto=function(e){if(t.confirm(r.instant("RESERVATION_CATEGORIES.PHOTOS.CONFIRM_DELETE")))return d.deletePhoto(o.getCurrentCenterId(),u.category.id,e.id).then(function(){var t=s.findIndexByKeyValue(u.category.photos,"id",e.id);t>=0&&u.category.photos.splice(t,1)}).catch(function(e){return i.error(e,"Failed to remove reservation category photo.")})}}]),angular.module("deskworks.inventory.reservationCategories",["dnd","deskworks.state","deskworks.reservationCategory.service"]).controller("InventoryReservationCategoriesCtrl",["$scope","$translate","state","dnd","dwAlerts","reservationCategories","reservationCategoryService",function(e,t,r,n,i,o,s){"use strict";r.setPageTitle(t.instant("RESERVATION_CATEGORIES.PAGE_TITLE")),this.categories=o,this.edit=function(e){return r.setPath("/reservation-types/"+e.id)},this.new=function(){return r.setPath("/reservation-types/new")},this.onDrop=function(e,t,o,a){var c=n.move(e,t,o,a);return c.$spin=!0,s.update(r.getCurrentCenterId(),c.id,{order:c.order}).catch(function(e){return i.error(e,"Failed to reorder reservation category.")}).finally(function(){delete c.$spin}),!0}}]),angular.module("deskworks.inventory.reservationUnit.edit",["deskworks.reservationCategory.service","deskworks.reservationUnit.service","deskworks.reservationRules"]).controller("InventoryReservationUnitEditCtrl",["$scope","$route","$translate","dwAlerts","state","helper","reservationUnit","reservationCategories","reservationUnitService",function(e,t,r,n,i,o,s,a,c){"use strict";var d=this;i.setPageTitle(r.instant("new"===s.id?"RESERVATION_UNITS.NEW.PAGE_TITLE":"RESERVATION_UNITS.EDIT.PAGE_TITLE")),d.reservationUnit=s,d.categories=a,d.reservationUnit.reservationCategory=o.findByKeyValue(d.categories,"id",d.reservationUnit.reservationTypeId)||d.categories[0],d.saveReservationUnit=function(e){if(!o.pointFirstInvalid("#reservation-unit-edit")){var r={name:d.reservationUnit.name,reservationTypeId:d.reservationUnit.reservationCategory.id,syncWithCalendar:d.reservationUnit.syncWithCalendar,calendarId:d.reservationUnit.calendarId,description:d.reservationUnit.description,expectedUsePerMonth:d.reservationUnit.expectedUsePerMonth};return("new"===d.reservationUnit.id?c.createReservationUnit(i.getCurrentCenterId(),r):c.updateReservationUnit(i.getCurrentCenterId(),d.reservationUnit.id,r)).then(function(e){if(d.form.$setPristine(),"new"===d.reservationUnit.id)return i.setPath("/reservation-units/"+e.id);t.reload()}).catch(function(e){return n.error(e,"Failed to save reservation unit.")})}},d.removeReservationUnit=function(){if(confirm(r.instant("RESERVATION_UNITS.CONFIRM_DELETE")))return c.deleteReservationUnit(i.getCurrentCenterId(),d.reservationUnit.id).then(function(){return i.setPath("/reservation-units")}).catch(function(e){return n.error(e,"Failed to remove reservation unit.")})},d.back=function(){return i.setPath("/reservation-units")},d.calSyncChange=function(){d.reservationUnit.syncWithCalendar||(d.reservationUnit.calendarId=null),d.calendarIdEnabled=d.reservationUnit.syncWithCalendar},e.$watch("state.getCurrentCenterId()",function(e,t){e!==t&&i.setPath("/reservation-units")}),d.uploadPhoto=function(t,o){return o&&o.length>0?n.error(r.instant("GLOBAL.PHOTO.INVALID_FORMAT")):t&&t.length>0?(d.spinPhoto=!0,c.uploadPhoto(i.getCurrentCenterId(),d.reservationUnit.id,t[0]).catch(function(e){return d.spinPhoto=!1,n.error(e,"Failed to upload reservation unit photo.")}).then(function(t){return d.spinPhoto=!1,d.reservationUnit.photo=t.data.photo,e.$emit("CENTERS:REFRESH"),t.data})):void 0}}]),angular.module("deskworks.inventory.reservationUnit.list",["deskworks.reservationUnit.service","deskworks.reservationRules.optsWhoCanReserve"]).controller("InventoryReservationUnitListCtrl",["$scope","$translate","state","helper","reservationUnits","optsWhoCanReserve",function(e,t,r,n,i,o){"use strict";r.setPageTitle(t.instant("RESERVATION_UNITS.PAGE_TITLE")),this.reservationUnits=i,this.reservationUnits.forEach(function(e){e.whoCanReserve=(n.findByKeyValue(o,"id",e.whoCanReserve)||{}).name}),this.edit=function(e){return r.setPath("/reservation-units/"+e.id)},this.new=function(){return r.setPath("/reservation-units/new")}}]);