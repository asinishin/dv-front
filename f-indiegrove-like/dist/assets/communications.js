angular.module("deskworks.communications.emailAllMembers",["deskworks.emailAllMembers.service","deskworks.getAttachments.service","deskworks.taToolbarEmail"]).controller("EmailAllMembersCtrl",["$scope","$templateCache","$translate","dwAlerts","state","helper","emailAllMembers","getAttachments","taToolbarEmail",function(e,t,s,n,a,r,i,o,c){"use strict";var l=this;a.setPageTitle(s.instant("EMAIL_MEMBERS.ALL.PAGE_TITLE")),l.toolbar=c,l.attachments=[],l.body=s.instant("EMAIL_MEMBERS.MESSAGE.ALL.DEFAULT"),l.send=function(e){if(!r.pointFirstInvalid("#emailAllMembers")){var t={includeNonMembers:l.includeNonMembers,subject:l.subject,body:l.body,attachments:l.attachments};return i.send(t,e).then(function(){n.info(e?s.instant("EMAIL_MEMBERS.TEST_SUCCESS"):s.instant("EMAIL_MEMBERS.SUCCESS")),e||l.form.$setPristine()}).catch(function(e){return n.error(e,"Failed to email all members.")})}},l.viewRecipients=function(){return i.query(l.includeNonMembers).catch(function(e){return n.error(e,"Failed to query recipients.")}).then(function(e){l.recipients=e})},l.attach=function(e){o(e).then(function(e){l.attachments=l.attachments.concat(e),l.form.$setDirty()})},l.detach=function(e){l.attachments.splice(e,1),l.form.$setDirty()}}]),angular.module("deskworks.communications.emailSiteMembers",["deskworks.emailSiteMembers.service","deskworks.getAttachments.service","deskworks.taToolbarEmail"]).controller("EmailSiteMembersCtrl",["$scope","$templateCache","$translate","dwAlerts","state","helper","emailSiteMembers","membershipCategories","center","getAttachments","taToolbarEmail",function(e,t,s,n,a,r,i,o,c,l,m){"use strict";var u=this;a.setPageTitle(s.instant("EMAIL_MEMBERS.SITE.PAGE_TITLE",{centerName:c.name})),u.toolbar=m,o.unshift({id:0,name:s.instant("EMAIL_MEMBERS.OPTIONS.MEMBERSHIP.ALL")}),u.membershipCategories=o,u.membershipCategory=u.membershipCategories[0],u.attachments=[],u.body=s.instant("EMAIL_MEMBERS.MESSAGE.SITE.DEFAULT"),u.send=function(e){if(!r.pointFirstInvalid("#emailSiteMembers")){var t={membershipTypeId:u.membershipCategory.id,subject:u.subject,body:u.body,attachments:u.attachments,checkedInOnly:u.checkedInOnly};return i.send(a.getCurrentCenterId(),t,e).then(function(){n.info(e?s.instant("EMAIL_MEMBERS.TEST_SUCCESS"):s.instant("EMAIL_MEMBERS.SUCCESS")),e||u.form.$setPristine()}).catch(function(e){return n.error(e,"Failed to email site members.")})}},u.viewRecipients=function(){return i.query(a.getCurrentCenterId(),u.membershipCategory.id,u.checkedInOnly).catch(function(e){return n.error(e,"Failed to query recipients.")}).then(function(e){u.recipients=e})},u.attach=function(e){l(e).then(function(e){u.attachments=u.attachments.concat(e),u.form.$setDirty()})},u.detach=function(e){u.attachments.splice(e,1),u.form.$setDirty()}}]),angular.module("deskworks.MessageBoardCtrl",["NATS","infinite-scroll","deskworks.MessageBoard"]).controller("MessageBoardCtrl",["$scope","$translate","$window","$timeout","dwAlerts","state","helper","MessageBoard","NATS",function(e,t,s,n,a,r,i,o,c){"use strict";var l=this;r.setPageTitle(t.instant("MESSAGE_BOARD.PAGE_TITLE")),l.messageMaxLength=1e3,l.message={},l.messages=[],l.params={centerId:r.getCurrentCenterId(),offset:0,limit:100};var m=[];function u(e){e=o.deserialize(e);var t=i.find(l.messages,e.id);if(t)return angular.extend(t,e);l.messages.unshift(e)}function d(e){var t=i.find(l.messages,e.id);if(t)return angular.extend(t,e)}function f(e){var t=i.findIndex(l.messages,e.id);t>=0&&l.messages.splice(t,1)}n(function(){l.nats=c.connect(),l.nats.on("error",function(e){console.warn("NATS error:",e)}),e.$on("$destroy",function(){m.forEach(function(e){l.nats.unsubscribe(e)}),l.nats.close()}),i.focus(".message-board .msg-post textarea")}),l.fetch=function(){if(l.eof||l.fetching)return l.fetching;l.fetching=o.query(l.params).catch(function(e){return a.error(e,"Failed to query messages.")}).finally(function(){l.fetching=null}).then(function(e){l.messages=l.messages.concat(e),l.params.offset=l.messages.length,l.eof=e.length<l.params.limit,m.length||(m.push(l.nats.subscribe("API.:siteId.centers.:centerId.message-board.messages.create",u)),m.push(l.nats.subscribe("API.:siteId.centers.:centerId.message-board.messages.update",d)),m.push(l.nats.subscribe("API.:siteId.centers.:centerId.message-board.messages.delete",f)))})},l.post=function(){if(!l.posting&&l.message.text)return l.message.centerId=l.message.centerId||r.getCurrentCenterId(),l.posting=!0,o.save(l.message).catch(function(e){return a.error(e,"Failed to save message.")}).then(function(){l.message={}}).finally(function(){l.posting=!1})},l.keypress=function(e){13!==e.which||e.shiftKey||(e.preventDefault(),l.post())},l.edit=function(e){l.message=angular.copy(e),i.focus(".msg-post textarea")},l.delete=function(e){if(s.confirm(t.instant("MESSAGE_BOARD.MESSAGES.CONFIRM_DELETE")))return l.message.id===e.id&&(l.message={}),o.delete(e.id).catch(function(e){return a.error(e,"Failed to delete message.")})}}]),angular.module("deskworks.SplashPageCtrl",["deskworks.SplashPage","deskworks.taToolbarEmail"]).controller("SplashPageCtrl",["$scope","$translate","$timeout","dwAlerts","state","helper","center","splashPage","SplashPage","taToolbarEmail",function(e,t,s,n,a,r,i,o,c,l){"use strict";var m=this;a.setPageTitle(t.instant("SPLASH_PAGE.PAGE_TITLE",{centerName:i.name})),m.sp=o,m.toolbar=l,s(function(){angular.element(document.querySelectorAll("#splashPage ff-richtext .ta-toolbar")).after('<header class="header ta-fake-header" role="banner"><a href="javascript:void(0)" target="_blank"></a></header>')}),m.save=function(){if(!r.pointFirstInvalid("#splashPage"))return c.save(a.getCurrentCenterId(),m.sp).catch(function(e){return n.error(e,"Failed to save splash page settings.")}).then(function(){m.form.$setPristine()})}}]);